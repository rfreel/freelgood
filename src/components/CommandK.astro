<div class="commandk-overlay" hidden data-commandk>
  <div class="commandk-panel">
    <div>
      <strong>Search chapters</strong>
      <p class="muted" style="margin: 0.25rem 0 0;">Type a title or heading.</p>
    </div>
    <input type="search" placeholder="Search the manual" data-commandk-input />
    <div class="commandk-results" data-commandk-results></div>
  </div>
</div>

<script is:inline>
  (function () {
    var overlay = document.querySelector("[data-commandk]");
    var input = document.querySelector("[data-commandk-input]");
    var results = document.querySelector("[data-commandk-results]");
    if (!overlay || !input || !results) return;

    var index = [];
    var loaded = false;

    function open() {
      overlay.hidden = false;
      input.focus();
    }

    function close() {
      overlay.hidden = true;
      input.value = "";
      results.innerHTML = "";
    }

    function render(items) {
      results.innerHTML = "";
      if (!items.length) {
        results.innerHTML = '<span class="muted">No matches.</span>';
        return;
      }
      items.forEach(function (item) {
        var button = document.createElement("button");
        button.type = "button";
        button.innerHTML =
          '<strong>' +
          item.title +
          '</strong><div class="muted">' +
          item.context +
          "</div>";
        button.addEventListener("click", function () {
          window.location.href = item.href;
        });
        results.appendChild(button);
      });
    }

    async function ensureIndex() {
      if (loaded) return;
      var response = await fetch("/search-index.json");
      index = await response.json();
      loaded = true;
    }

    function filter(query) {
      if (!query) {
        render([]);
        return;
      }
      var q = query.toLowerCase();
      var matches = index
        .filter(function (item) {
          return (
            item.title.toLowerCase().includes(q) ||
            item.context.toLowerCase().includes(q)
          );
        })
        .slice(0, 12);
      render(matches);
    }

    document.addEventListener("keydown", function (event) {
      if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "k") {
        event.preventDefault();
        ensureIndex().then(open);
      }
      if (event.key === "Escape" && !overlay.hidden) {
        close();
      }
    });

    overlay.addEventListener("click", function (event) {
      if (event.target === overlay) {
        close();
      }
    });

    input.addEventListener("input", function () {
      filter(input.value);
    });
  })();
</script>
